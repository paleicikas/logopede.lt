<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dokumento generatorius</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid py-4 px-4">
        <div class="row" id="mainRow">
            <!-- Document preview (hidden initially, shown on left) -->
            <div class="col-md-9 d-none" id="documentCol">
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Sugeneruotas dokumentas</strong>
                        <button class="btn btn-sm btn-outline-primary" id="btnCopy" title="Kopijuoti">
                            <i class="bi bi-clipboard"></i> Kopijuoti
                        </button>
                    </div>
                    <div class="card-body bg-warning-subtle bg-opacity-25" id="documentPreview">
                        <p class="text-muted">Pasirinkite bent vieną elementą.</p>
                    </div>
                </div>
            </div>

            <!-- Form column -->
            <div class="col-12" id="formCol">
                <div class="card mb-3">
                    <div class="card-body">
                        <div id="formFields">
                            <p class="text-muted">Kraunama...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="copyToast" class="toast align-items-center text-bg-success" role="alert">
            <div class="d-flex">
                <div class="toast-body">Dokumentas nukopijuotas!</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let data = [];
        let isGenerated = false;

        async function loadDefaultData() {
            try {
                const response = await fetch('data.json');
                data = await response.json();
                renderForm();
            } catch (e) {
                document.getElementById('formFields').innerHTML =
                    '<p class="text-danger">Nepavyko užkrauti data.json</p>';
            }
        }

        function esc(str) {
            return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;');
        }

        function renderForm() {
            const container = document.getElementById('formFields');
            if (!data.length) {
                container.innerHTML = '<p class="text-muted">Nėra duomenų.</p>';
                return;
            }

            container.innerHTML = data.map((field, fi) => {
                let html = `<div class="mb-3 pb-2 border-bottom">`;
                html += `<div class="fw-bold mb-1">${esc(field.title)} <a href="#" class="fw-normal text-decoration-none small text-muted ms-1 d-none" data-clear="${fi}" onclick="clearField(${fi}); return false;">&#x2715;</a></div>`;

                // Radio options (objects with label + optional checkboxes)
                if (field.radio && field.radio.length) {
                    html += field.radio.map((opt, oi) => {
                        let rHtml = `
                            <div class="form-check form-check-inline">
                                <input class="form-check-input field-radio" type="radio"
                                       name="radio_${fi}" id="radio_${fi}_${oi}"
                                       value="${esc(opt.label)}" data-field="${fi}" data-radio="${oi}">
                                <label class="form-check-label" for="radio_${fi}_${oi}">${esc(opt.label)}</label>
                            </div>`;

                        // Nested checkboxes (hidden until this radio is selected)
                        if (opt.checkboxes && opt.checkboxes.length) {
                            rHtml += `<div class="ms-4 d-none" id="rcb_${fi}_${oi}">`;
                            rHtml += opt.checkboxes.map((cb, ci) => `
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input field-cb-nested" type="checkbox"
                                           id="cb_${fi}_${oi}_${ci}" value="${esc(cb)}"
                                           data-field="${fi}" data-radio="${oi}">
                                    <label class="form-check-label" for="cb_${fi}_${oi}_${ci}">${esc(cb)}</label>
                                </div>
                            `).join('');
                            rHtml += `</div>`;
                        }

                        return rHtml;
                    }).join('');
                }

                // Standalone checkboxes (field-level, not tied to radio)
                if (field.checkboxes && field.checkboxes.length) {
                    html += field.checkboxes.map((cb, ci) => `
                        <div class="form-check form-check-inline">
                            <input class="form-check-input field-cb-standalone" type="checkbox"
                                   id="scb_${fi}_${ci}" value="${esc(cb)}" data-field="${fi}">
                            <label class="form-check-label" for="scb_${fi}_${ci}">${esc(cb)}</label>
                        </div>
                    `).join('');
                }

                html += `</div>`;
                return html;
            }).join('');

            // Radio change: show/hide nested checkboxes
            container.querySelectorAll('.field-radio').forEach(radio => {
                radio.addEventListener('change', () => {
                    const fi = radio.dataset.field;
                    const oi = radio.dataset.radio;

                    // Hide all nested checkbox groups for this field
                    container.querySelectorAll(`[id^="rcb_${fi}_"]`).forEach(el => {
                        el.classList.add('d-none');
                        // Uncheck hidden checkboxes
                        el.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    });

                    // Show checkboxes for selected radio (if any)
                    const target = document.getElementById(`rcb_${fi}_${oi}`);
                    if (target) target.classList.remove('d-none');

                    // Show clear link
                    document.querySelector(`[data-clear="${fi}"]`).classList.remove('d-none');

                    onFieldChange();
                });
            });

            // Checkbox change
            container.querySelectorAll('.field-cb-nested, .field-cb-standalone').forEach(cb => {
                cb.addEventListener('change', onFieldChange);
            });
        }

        function clearField(fi) {
            // Uncheck radio
            document.querySelectorAll(`input[name="radio_${fi}"]`).forEach(r => r.checked = false);

            // Hide and uncheck nested checkboxes
            document.querySelectorAll(`[id^="rcb_${fi}_"]`).forEach(el => {
                el.classList.add('d-none');
                el.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            });

            // Hide clear link
            document.querySelector(`[data-clear="${fi}"]`).classList.add('d-none');

            onFieldChange();
        }

        function onFieldChange() {
            const anySelected =
                document.querySelectorAll('.field-radio:checked').length > 0 ||
                document.querySelectorAll('.field-cb-standalone:checked').length > 0;

            if (anySelected && !isGenerated) {
                switchToGeneratedLayout();
            } else if (!anySelected && isGenerated) {
                switchToInitialLayout();
            } else if (isGenerated) {
                updateDocument();
            }
        }

        function getFieldSelections() {
            const results = [];
            data.forEach((field, fi) => {
                let main = [];
                let sub = [];

                // Selected radio
                const radio = document.querySelector(`input[name="radio_${fi}"]:checked`);
                if (radio) {
                    main.push(radio.value);

                    // Nested checkboxes of selected radio
                    const oi = radio.dataset.radio;
                    document.querySelectorAll(`#rcb_${fi}_${oi} input[type="checkbox"]:checked`).forEach(cb => {
                        sub.push(cb.value);
                    });
                }

                // Standalone checkboxes
                document.querySelectorAll(`.field-cb-standalone[data-field="${fi}"]:checked`).forEach(cb => {
                    main.push(cb.value);
                });

                if (main.length || sub.length) {
                    results.push({ title: field.title, main, sub });
                }
            });
            return results;
        }

        function updateDocument() {
            const preview = document.getElementById('documentPreview');
            const selections = getFieldSelections();
            if (!selections.length) {
                preview.innerHTML = '<p class="text-muted">Pasirinkite bent vieną elementą.</p>';
                return;
            }
            preview.innerHTML = selections.map(s => {
                let text = s.main.map(v => esc(v.toLowerCase())).join(', ');
                if (s.sub.length) {
                    text += ` (${s.sub.map(v => esc(v.toLowerCase())).join(', ')})`;
                }
                return `<p class="mb-0"><strong>${esc(s.title)}:</strong> ${text}</p>`;
            }).join('');
        }

        function switchToGeneratedLayout() {
            isGenerated = true;
            document.getElementById('documentCol').classList.remove('d-none');
            document.getElementById('formCol').classList.remove('col-12');
            document.getElementById('formCol').classList.add('col-md-3');
            updateDocument();
        }

        function switchToInitialLayout() {
            isGenerated = false;
            document.getElementById('documentCol').classList.add('d-none');
            document.getElementById('formCol').classList.remove('col-md-3');
            document.getElementById('formCol').classList.add('col-12');
        }

        async function copyDocument() {
            const preview = document.getElementById('documentPreview');
            try {
                await navigator.clipboard.writeText(preview.innerText);
                const toast = new bootstrap.Toast(document.getElementById('copyToast'));
                toast.show();
            } catch (e) {
                const range = document.createRange();
                range.selectNodeContents(preview);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                document.execCommand('copy');
                sel.removeAllRanges();
                const toast = new bootstrap.Toast(document.getElementById('copyToast'));
                toast.show();
            }
        }

        document.getElementById('btnCopy').addEventListener('click', copyDocument);

        loadDefaultData();
    </script>
</body>
</html>
